{% extends 'base.html' %}

{% block title %}Administração{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mt-2 mb-3">
    <h2 class="mb-0">Painel de Administração</h2>
</div>

<div class="admin-tabs">
    <ul class="nav nav-pills" id="adminTab" role="tablist">
        {% if session.get('user_role') == 'admin' %}
        <li class="nav-item">
            <a class="nav-link active" id="usuarios-tab" data-toggle="tab" href="#usuarios" role="tab" aria-controls="usuarios" aria-selected="true">
                <i class="fas fa-users mr-2"></i>Usuários
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="configuracoes-tab" data-toggle="tab" href="#configuracoes" role="tab" aria-controls="configuracoes" aria-selected="false">
                <i class="fas fa-robot mr-2"></i>Configurações do Robô
            </a>
        </li>
        {% endif %}
        <li class="nav-item">
            <a class="nav-link {% if session.get('user_role') != 'admin' %}active{% endif %}" id="historico-robo-tab" data-toggle="tab" href="#historico-robo" role="tab" aria-controls="historico-robo" aria-selected="false">
                <i class="fas fa-history mr-2"></i>Histórico Robô
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="dashboard-tab" data-toggle="tab" href="#dashboard" role="tab" aria-controls="dashboard" aria-selected="false">
                <i class="fas fa-chart-line mr-2"></i>Dashboard
            </a>
        </li>
    </ul>
</div>

<div class="tab-content" id="adminTabContent">
    {% if session.get('user_role') == 'admin' %}
    <!-- Seção de Usuários -->
    <div class="tab-pane fade show active" id="usuarios" role="tabpanel" aria-labelledby="usuarios-tab">
        <div class="card mt-4">
            <div class="card-header"><h3 class="card-title mb-0">Adicionar Novo Usuário</h3></div>
            <div class="card-body">
                <form action="{{ url_for('add_usuario') }}" method="post">
                    <div class="form-row">
                        <div class="col-md-6 mb-3"><label for="username">Nome de Usuário</label><input type="text" class="form-control form-control-sm" id="username" name="username" placeholder="Nome de Usuário" required></div>
                        <div class="col-md-6 mb-3"><label for="nome">Nome Completo</label><input type="text" class="form-control form-control-sm" id="nome" name="nome" placeholder="Nome Completo" required></div>
                    </div>
                    <div class="form-row">
                        <div class="col-md-6 mb-3"><label for="password">Senha</label><input type="password" class="form-control form-control-sm" id="password" name="password" placeholder="Senha" required></div>
                        <div class="col-md-6 mb-3"><label for="confirm_password">Repetir Senha</label><input type="password" class="form-control form-control-sm" id="confirm_password" name="confirm_password" placeholder="Repetir Senha" required></div>
                    </div>
                    <div class="form-row">
                        <div class="col-md-6 mb-3"><label for="email">E-mail</label><input type="email" class="form-control form-control-sm" id="email" name="email" placeholder="E-mail" required></div>
                        <div class="col-md-6 mb-3"><label for="role">Permissão</label><select name="role" class="form-control form-control-sm" id="role" required><option value="user">Usuário Comum</option><option value="admin">Administrador</option></select></div>
                    </div>
                    <div class="form-row">
                        <div class="col-md-6 mb-3"><label for="telefone_fixo">Telefone Fixo</label><input type="text" class="form-control form-control-sm" id="telefone_fixo" name="telefone_fixo" placeholder="Telefone Fixo"></div>
                        <div class="col-md-6 mb-3"><label for="celular">Celular</label><input type="text" class="form-control form-control-sm" id="celular" name="celular" placeholder="Celular"></div>
                    </div>
                    <button type="submit" class="btn btn-success mt-2">Adicionar Usuário</button>
                </form>
            </div>
        </div>
        <div class="card mt-4">
            <div class="card-header"><h3 class="card-title mb-0">Usuários Cadastrados</h3></div>
            <div class="card-body"><table class="table table-striped table-sm"><thead><tr><th>ID</th><th>Nome de Usuário</th><th>Nome Completo</th><th>E-mail</th><th>Permissão</th><th>Ações</th></tr></thead><tbody>
                {% for usuario in usuarios %}
                <tr><td>{{ usuario.id }}</td><td>{{ usuario.username }}</td><td>{{ usuario.nome }}</td><td>{{ usuario.email }}</td><td>{{ usuario.role }}</td><td><a href="{{ url_for('edit_usuario', id=usuario.id) }}" class="btn btn-sm btn-primary"><i class="fas fa-edit"></i></a> {% if usuario.id != session['user_id'] %}<a href="{{ url_for('delete_usuario', id=usuario.id) }}" class="btn btn-sm btn-danger" onclick="return confirm('Tem certeza que deseja deletar este usuário?');"><i class="fas fa-trash"></i></a>{% endif %}</td></tr>
                {% endfor %}
            </tbody></table></div>
        </div>
    </div>

    <!-- Seção de Configurações do Robô -->
    <div class="tab-pane fade" id="configuracoes" role="tabpanel" aria-labelledby="configuracoes-tab">
        <div class="card mt-4">
            <div class="card-header"><h3 class="card-title mb-0">Configurações do Robô de Automação</h3></div>
            <div class="card-body">
                <form action="{{ url_for('salvar_configuracao_robo') }}" method="post">
                    <div class="form-row mb-4"> <!-- Adicionado mb-4 para espaçamento -->
                        <div class="form-group col-md-12"> <!-- Ocupa a largura total para destaque -->
                            <p class="text-sm font-medium text-gray-700 mb-2">Status do Evento Header do Robô:</p>
                            <div class="custom-control custom-switch custom-control-lg">
                                <input type="checkbox" class="custom-control-input" id="head_evento" name="head_evento" {% if configuracao.head_evento %}checked{% endif %}>
                                <label class="custom-control-label custom-switch-label" for="head_evento">
                                    <span class="switch-label-text"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <h5 class="mb-3 mt-2 text-primary">Acesso e Credenciais</h5>
                    <div class="form-row">
                        <div class="form-group col-md-4"><label for="url_acesso">Pagina RPA</label><input type="url" class="form-control form-control-sm" id="url_acesso" name="url_acesso" value="{{ configuracao.url_acesso if configuracao else '' }}" required></div>
                        <div class="form-group col-md-4"><label for="usuario_site">Usuario RPA</label><input type="text" class="form-control form-control-sm" id="usuario_site" name="usuario_site" value="{{ configuracao.usuario_site if configuracao else '' }}" required></div>
                        <div class="form-group col-md-4"><label for="senha_site">Senha RPA</label><input type="password" class="form-control form-control-sm" id="senha_site" name="senha_site" value="{{ configuracao.senha_site if configuracao else '' }}" required></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group col-md-4"><label for="filial">Filial</label><input type="text" class="form-control form-control-sm" id="filial" name="filial" value="{{ configuracao.filial if configuracao else '' }}" required></div>
                    </div>
                    <hr>
                    <h5 class="mb-3 mt-3 text-primary">Configurações Adicionais</h5>
                                        <div class="form-row">
                                            <div class="form-group col-md-8"><label for="pagina_raspagem">Página de Raspagem</label><input type="url" class="form-control form-control-sm" id="pagina_raspagem" name="pagina_raspagem" value="{{ configuracao.pagina_raspagem if configuracao else '' }}"></div>
                                            <div class="form-group col-md-4"><label for="email_retorno">E-mail de Retorno</label><input type="email" class="form-control form-control-sm" id="email_retorno" name="email_retorno" value="{{ configuracao.email_retorno if configuracao else '' }}" required></div>
                                        </div>
                    <button type="submit" class="btn btn-success mt-3"><i class="fas fa-save mr-2"></i>Salvar Configurações</button>
                </form>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Seção de Histórico Robô -->
    <div class="tab-pane fade {% if session.get('user_role') != 'admin' %}show active{% endif %}" id="historico-robo" role="tabpanel" aria-labelledby="historico-robo-tab">
        <div class="card mt-4">
             <div class="card-header"><h3 class="card-title mb-0">Histórico de Execuções</h3></div>
            <div class="card-body"><p>Aqui será exibido o histórico de execuções do robô.</p></div>
        </div>
    </div>

    <!-- Seção de Dashboard -->
    <div class="tab-pane fade" id="dashboard" role="tabpanel" aria-labelledby="dashboard-tab">
        <div class="card mt-4">
             <div class="card-header"><h3 class="card-title mb-0">Dashboard</h3></div>
            <div class="card-body"><p>Aqui será exibido um dashboard com informações relevantes.</p></div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const headEventoSwitch = document.getElementById('head_evento');
            const switchLabelText = headEventoSwitch.nextElementSibling.querySelector('.switch-label-text');

            function updateSwitchLabel() {
                if (headEventoSwitch.checked) {
                    switchLabelText.textContent = 'Evento Header do Robo ativo';
                } else {
                    switchLabelText.textContent = 'Evento Header do Robo Desativado';
                }
            }

            // Initial update
            updateSwitchLabel();

            // Update on change
            headEventoSwitch.addEventListener('change', updateSwitchLabel);
        });
    </script>
{% endblock %}