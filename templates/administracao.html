{% extends 'base.html' %}

{% block title %}Administração{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mt-2 mb-2">
    <h3 class="mb-0">Painel de Administração</h3>
</div>

{% set default_active = 'configuracoes' if g.user.role in ['admin', 'dev'] else 'historico-robo' %}
{% set current_active_tab = active_tab or default_active %}
<div class="admin-tabs">
    <ul class="nav nav-pills" id="adminTab" role="tablist">
        {% if g.user.role in ['admin', 'dev'] %}
        <li class="nav-item">
            <a class="nav-link {% if current_active_tab == 'usuarios' %}active{% endif %}" id="usuarios-tab" data-toggle="tab" href="#usuarios" role="tab" aria-controls="usuarios" aria-selected="{{ 'true' if current_active_tab == 'usuarios' else 'false' }}">
                <i class="fas fa-users mr-2"></i>Usuários
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link {% if current_active_tab == 'configuracoes' %}active{% endif %}" id="configuracoes-tab" data-toggle="tab" href="#configuracoes" role="tab" aria-controls="configuracoes" aria-selected="{{ 'true' if current_active_tab == 'configuracoes' else 'false' }}">
                <i class="fas fa-robot mr-2"></i>Configurações do Robô
            </a>
        </li>
        {% endif %}
        <li class="nav-item">
            <a class="nav-link {% if current_active_tab == 'historico-robo' %}active{% endif %}" id="historico-robo-tab" data-toggle="tab" href="#historico-robo" role="tab" aria-controls="historico-robo" aria-selected="{{ 'true' if current_active_tab == 'historico-robo' else 'false' }}">
                <i class="fas fa-history mr-2"></i>Histórico Robô
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link {% if current_active_tab == 'dashboard' %}active{% endif %}" id="dashboard-tab" data-toggle="tab" href="#dashboard" role="tab" aria-controls="dashboard" aria-selected="{{ 'true' if current_active_tab == 'dashboard' else 'false' }}">
                <i class="fas fa-chart-line mr-2"></i>Dashboard
            </a>
        </li>
    </ul>
</div>

<div class="tab-content" id="adminTabContent">
    {% if g.user.role in ['admin', 'dev'] %}
    <!-- Seção de Usuários -->
    <div class="tab-pane fade {% if current_active_tab == 'usuarios' %}show active{% endif %}" id="usuarios" role="tabpanel" aria-labelledby="usuarios-tab">
        <div class="card mt-3">
            <div class="card-header py-2"><h5 class="card-title mb-0">Adicionar Novo Usuário</h5></div>
            <div class="card-body p-3">
                <form action="{{ url_for('add_usuario') }}" method="post">
                    <div class="form-row">
                        <div class="col-md-4 mb-2"><label for="username" class="col-form-label-sm">Usuário</label><input type="text" class="form-control form-control-sm" id="username" name="username" required></div>
                        <div class="col-md-4 mb-2"><label for="nome" class="col-form-label-sm">Nome Completo</label><input type="text" class="form-control form-control-sm" id="nome" name="nome" required></div>
                        <div class="col-md-4 mb-2"><label for="email" class="col-form-label-sm">E-mail</label><input type="email" class="form-control form-control-sm" id="email" name="email" required></div>
                    </div>
                    <div class="form-row">
                        <div class="col-md-4 mb-2"><label for="password" class="col-form-label-sm">Senha</label><input type="password" class="form-control form-control-sm" id="password" name="password" required></div>
                        <div class="col-md-4 mb-2"><label for="confirm_password" class="col-form-label-sm">Repetir Senha</label><input type="password" class="form-control form-control-sm" id="confirm_password" name="confirm_password" required></div>
                        <div class="col-md-4 mb-2"><label for="role" class="col-form-label-sm">Permissão</label><select name="role" class="form-control form-control-sm" id="role" required><option value="user">Usuário Comum</option><option value="admin">Administrador</option></select></div>
                    </div>
                    <div class="form-row">
                        <div class="col-md-4 mb-2"><label for="telefone_fixo" class="col-form-label-sm">Telefone Fixo</label><input type="text" class="form-control form-control-sm" id="telefone_fixo" name="telefone_fixo"></div>
                        <div class="col-md-4 mb-2"><label for="celular" class="col-form-label-sm">Celular</label><input type="text" class="form-control form-control-sm" id="celular" name="celular"></div>
                    </div>
                    <button type="submit" class="btn btn-success btn-sm mt-2">Adicionar Usuário</button>
                </form>
            </div>
        </div>
        <div class="card mt-3">
            <div class="card-header py-2"><h5 class="card-title mb-0">Usuários Cadastrados</h5></div>
            <div class="card-body p-2"><div class="table-responsive"><table class="table table-striped table-sm"><thead><tr><th>ID</th><th>Usuário</th><th>Nome</th><th>E-mail</th><th>Permissão</th><th>Ações</th></tr></thead><tbody>
                {% for usuario in usuarios %}
                <tr><td>{{ usuario.id }}</td><td>{{ usuario.username }}</td><td>{{ usuario.nome }}</td><td>{{ usuario.email }}</td><td>{{ usuario.role }}</td><td><a href="{{ url_for('edit_usuario', id=usuario.id) }}" class="btn btn-sm btn-primary"><i class="fas fa-edit"></i></a> {% if usuario.id != session['user_id'] %}<a href="{{ url_for('delete_usuario', id=usuario.id) }}" class="btn btn-sm btn-danger" onclick="return confirm('Tem certeza que deseja deletar este usuário?');"><i class="fas fa-trash"></i></a>{% endif %}</td></tr>
                {% endfor %}
            </tbody></table></div></div>
        </div>
    </div>

    <!-- Seção de Configurações do Robô -->
    <div class="tab-pane fade {% if current_active_tab == 'configuracoes' %}show active{% endif %}" id="configuracoes" role="tabpanel" aria-labelledby="configuracoes-tab">
        <div class="card mt-3">
            <div class="card-header py-2"><h5 class="card-title mb-0">Configurações do Robô</h5></div>
            <div class="card-body p-3">
                <form action="{{ url_for('salvar_configuracao_robo') }}" method="post">
                    <div class="form-row mb-2 align-items-center">
                        <div class="col-md-6">
                            <p class="small font-weight-bold mb-1">Mostrar eventos do robô em tela?</p>
                            <div class="custom-control custom-switch"><input type="checkbox" class="custom-control-input" id="head_evento" name="head_evento" {% if configuracao and configuracao.head_evento %}checked{% endif %}><label class="custom-control-label" for="head_evento"><span class="switch-label-text"></span></label></div>
                        </div>
                        <div class="col-md-6">
                            <p class="small font-weight-bold mb-1">Modo de Execução:</p>
                             <div class="custom-control custom-switch"><input type="checkbox" class="custom-control-input" id="modo_execucao" name="modo_execucao" {% if configuracao and configuracao.modo_execucao == 'agendado' %}checked{% endif %}><label class="custom-control-label" for="modo_execucao"><span class="switch-label-text"></span></label></div>
                        </div>
                    </div>
                    <hr class="my-2">
                    <h6 class="mb-2 mt-3 text-primary">Acesso e Credenciais</h6>
                    <div class="form-row">
                        <div class="form-group col-md-3 mb-2"><label class="col-form-label-sm">Pagina RPA</label><input type="url" class="form-control form-control-sm" name="url_acesso" value="{{ configuracao.url_acesso if configuracao else '' }}" required></div>
                        <div class="form-group col-md-3 mb-2"><label class="col-form-label-sm">Usuario RPA</label><input type="text" class="form-control form-control-sm" name="usuario_site" value="{{ configuracao.usuario_site if configuracao else '' }}" required></div>
                        <div class="form-group col-md-3 mb-2"><label class="col-form-label-sm">Senha RPA</label><input type="password" class="form-control form-control-sm" name="senha_site"></div>
                        <div class="form-group col-md-3 mb-2"><label class="col-form-label-sm">Filial</label><input type="text" class="form-control form-control-sm" name="filial" value="{{ configuracao.filial if configuracao else '' }}" required></div>
                    </div>
                    <hr class="my-2">
                    <h6 class="mb-2 mt-2 text-primary">Configurações Adicionais</h6>
                    <div class="form-row">
                        <div class="form-group col-md-4 mb-2"><label class="col-form-label-sm">Contato</label><input type="text" class="form-control form-control-sm" name="contato" value="{{ configuracao.contato if configuracao else '' }}"></div>
                        <div class="form-group col-md-4 mb-2"><label class="col-form-label-sm">Telefone</label><input type="text" class="form-control form-control-sm" name="telefone" value="{{ configuracao.telefone if configuracao else '' }}"></div>
                        <div class="form-group col-md-4 mb-2"><label class="col-form-label-sm">E-mail de Retorno</label><input type="email" class="form-control form-control-sm" name="email_retorno" value="{{ configuracao.email_retorno if configuracao else '' }}" required></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group col-md-8 mb-2"><label class="col-form-label-sm">Página de Raspagem</label><input type="url" class="form-control form-control-sm" name="pagina_raspagem" value="{{ configuracao.pagina_raspagem if configuracao else '' }}"></div>
                        <div class="form-group col-md-4 mb-2"><label class="col-form-label-sm">Tempo de Espera (segundos)</label><input type="number" class="form-control form-control-sm" name="tempo_espera_segundos" value="{{ configuracao.tempo_espera_segundos if configuracao else 30 }}" min="0"></div>
                    </div>
                    <button type="submit" class="btn btn-success btn-sm mt-2"><i class="fas fa-save mr-2"></i>Salvar Configurações</button>
                </form>
            </div>
        </div>
    </div>
    {% endif %}
    <!-- Seção de Histórico Robô -->
    <div class="tab-pane fade {% if current_active_tab == 'historico-robo' %}show active{% endif %}" id="historico-robo" role="tabpanel" aria-labelledby="historico-robo-tab">
        <div class="card mt-3">
             <div class="card-header py-2"><h5 class="card-title mb-0">Histórico de Execuções</h5></div>
            <div class="card-body p-2"><p>Aqui será exibido o histórico de execuções do robô.</p></div>
        </div>
    </div>

    <!-- Seção de Dashboard -->
    <div class="tab-pane fade {% if current_active_tab == 'dashboard' %}show active{% endif %}" id="dashboard" role="tabpanel" aria-labelledby="dashboard-tab">
        <div class="card mt-3">
             <div class="card-header py-2"><h5 class="card-title mb-0">Dashboard</h5></div>
            <div class="card-body p-2"><p>Aqui será exibido um dashboard com informações relevantes.</p></div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script>
        $(function () {
          $('[data-toggle="tooltip"]').tooltip()
        })

        document.addEventListener('DOMContentLoaded', function() {
            // Helper to get JWT token
            function getAuthHeaders() {
                const token = localStorage.getItem('jwt_token');
                const headers = {
                    'Content-Type': 'application/json'
                };
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }
                return headers;
            }
            
            // Helper function to update switch labels and colors
            function setupSwitch(switchId, onText, offText, onColorClass = '', offColorClass = '') {
                const switchElement = document.getElementById(switchId);
                if (!switchElement) return;

                const labelElement = switchElement.nextElementSibling; // The <label> element
                const labelTextElement = labelElement.querySelector('.switch-label-text');

                function updateLabelAndColor() {
                    if (switchElement.checked) {
                        labelTextElement.textContent = onText;
                        labelElement.classList.remove(offColorClass);
                        labelElement.classList.add(onColorClass);
                    } else {
                        labelTextElement.textContent = offText;
                        labelElement.classList.remove(onColorClass);
                        labelElement.classList.add(offColorClass);
                    }
                }

                // Initial update and event listener
                updateLabelAndColor();
                switchElement.addEventListener('change', updateLabelAndColor);
            }

            // Setup for 'Mostrar eventos do Robo em Tela?' switch
            setupSwitch('head_evento', 'Mostrar evento em Tela!', 'Evento background!', 'text-danger', 'text-success');

            // Setup for 'Modo de Execução' switch
            setupSwitch('modo_execucao', 'Agendamento Permitido', 'NÃO Permite Agendar!');
        });
    </script>
{% endblock %}